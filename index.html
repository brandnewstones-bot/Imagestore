<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Store</title>
  <script type="module">
    // --- Firebase SDK (v10+) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- Firebase Config (from you) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA5KtzxCIhpXBLyTzmKtjz1uX7mYD0MSnE",
      authDomain: "store-requests-80223.firebaseapp.com",
      projectId: "store-requests-80223",
      storageBucket: "store-requests-80223.firebasestorage.app",
      messagingSenderId: "473063205358",
      appId: "1:473063205358:web:43b94b0b227afd572886ff",
      measurementId: "G-L3H7Q9TDXK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- DOM elements (grab after DOM loads) ---
    const ownerMenu = () => document.getElementById('ownerMenu');
    const loginPopup = () => document.getElementById('loginPopup');
    const redDot = () => document.getElementById('redDot');
    const store = () => document.getElementById('store');
    const crossBtn = () => document.getElementById('ownerCloseBtn');

    // --- Owner UID (your provided one) ---
    const OWNER_UID = "47B3sjYcbUhVt0NVsaPvbSUy1NI3";

    // Keep UI in sync with auth state
    onAuthStateChanged(auth, (user) => {
      // If owner is logged in, ensure login popup hidden and cross visible
      if (user && user.uid === OWNER_UID) {
        // Hide login popup if any
        if (loginPopup()) loginPopup().style.display = 'none';
        // ensure the close button is visible when menu is open
        if (ownerMenu() && ownerMenu().style.display === 'block') {
          const btn = crossBtn();
          if (btn) btn.style.display = 'block';
        }
      } else {
        // not owner → hide owner menu and cross if present
        if (ownerMenu()) ownerMenu().style.display = 'none';
      }
    });

    // Red dot click: either show login popup (if not logged in) or toggle owner menu if owner
    window.addEventListener('DOMContentLoaded', () => {
      const dot = redDot();
      dot.addEventListener('click', () => {
        const user = auth.currentUser;
        if (!user) {
          // not signed in → require auth
          loginPopup().style.display = loginPopup().style.display === 'block' ? 'none' : 'block';
          return;
        }

        // signed in — ensure it's the owner
        if (user.uid === OWNER_UID) {
          // toggle menu (and show cross)
          const menu = ownerMenu();
          menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
          const btn = crossBtn();
          if (btn) btn.style.display = menu.style.display === 'block' ? 'block' : 'none';
        } else {
          alert('Unauthorized user.');
        }
      });
    });

    // Owner login function (email/password)
    window.ownerLogin = async function () {
      const email = document.getElementById('ownerEmail').value;
      const password = document.getElementById('ownerPassword').value;

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        if (userCredential.user.uid === OWNER_UID) {
          // hide login, show owner menu and cross
          loginPopup().style.display = 'none';
          ownerMenu().style.display = 'block';
          const btn = crossBtn();
          if (btn) btn.style.display = 'block';
        } else {
          // sign out immediately if wrong account
          await signOut(auth);
          alert('Unauthorized user.');
        }
      } catch (err) {
        alert('Login failed: ' + err.message);
      }
    };

    // Cross (close) button function: hide menu and sign out so next red-dot requires auth
    window.ownerCloseAndSignOut = async function () {
      try {
        // hide owner menu immediately
        if (ownerMenu()) ownerMenu().style.display = 'none';
        // sign out from Firebase so future red-dot clicks will require auth
        await signOut(auth);
      } catch (err) {
        console.error('Sign out failed:', err);
      }
    };

    // Add product function (same as before)
    window.addProduct = function () {
      const imageInput = document.getElementById('productImage');
      const priceInput = document.getElementById('productPrice');

      if (!imageInput.files[0] || !priceInput.value) {
        alert('Please upload image and enter price.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const productDiv = document.createElement('div');
        productDiv.classList.add('product');
        productDiv.innerHTML = `
          <img src="${e.target.result}" alt="New Product">
          <div class="price">$${priceInput.value}</div>
          <button class="buy-btn">Buy</button>
        `;
        store().appendChild(productDiv);

        // Reset fields and hide menu
        imageInput.value = '';
        priceInput.value = '';
        if (ownerMenu()) ownerMenu().style.display = 'none';
        // sign out to force auth next time (optional—keeps behavior consistent)
        signOut(auth).catch(() => {});
      };
      reader.readAsDataURL(imageInput.files[0]);
    };
  </script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    .banner { background: black; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .red-dot { width: 20px; height: 20px; background: red; border-radius: 50%; cursor: pointer; }

    .store { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 20px; }
    .product { background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 15px; text-align: center; }
    .product img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; }
    .price { margin: 10px 0; font-size: 18px; font-weight: bold; }
    .buy-btn { background: green; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }

    /* Owner menu */
    .owner-menu {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      width: 260px;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 100;
      transition: transform .12s ease, opacity .12s ease;
    }

    /* cross (close) button top-right */
    .owner-menu .close-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: none; /* shown only when owner menu open AND owner auth */
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      border: none;
      background: transparent;
      color: #444;
      font-size: 18px;
    }
    .owner-menu .close-btn:hover { color: #000; }

    .owner-menu input { display: block; margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    .owner-menu button { background: blue; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; width: 100%; }

    /* Login popup */
    .login-popup {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      width: 260px;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 200;
    }
    .login-popup input { display: block; margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
    .login-popup button { background: darkred; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; width: 100%; }
  </style>
</head>
<body>
  <div class="banner">
    <h1>My Store</h1>
    <div id="redDot" class="red-dot" title="Owner"></div>
  </div>

  <!-- Login Popup -->
  <div id="loginPopup" class="login-popup">
    <h3>Owner Login</h3>
    <input type="email" id="ownerEmail" placeholder="Email" autocomplete="username"/>
    <input type="password" id="ownerPassword" placeholder="Password" autocomplete="current-password"/>
    <button onclick="ownerLogin()">Login</button>
  </div>

  <!-- Owner Menu (includes close button) -->
  <div id="ownerMenu" class="owner-menu" aria-hidden="true">
    <!-- Cross/Close button (appears only for owner when menu shown) -->
    <button id="ownerCloseBtn" class="close-btn" title="Close" onclick="ownerCloseAndSignOut()">✕</button>

    <h3 style="margin-top:0">Add Product</h3>
    <input type="file" id="productImage" accept="image/*" />
    <input type="text" id="productPrice" placeholder="Enter price" />
    <button onclick="addProduct()">Add to Store</button>
  </div>

  <!-- Store -->
  <div id="store" class="store">
    <div class="product">
      <img src="https://via.placeholder.com/200x150" alt="Product 1">
      <div class="price">$10</div>
      <button class="buy-btn">Buy</button>
    </div>
    <div class="product">
      <img src="https://via.placeholder.com/200x150" alt="Product 2">
      <div class="price">$20</div>
      <button class="buy-btn">Buy</button>
    </div>
    <div class="product">
      <img src="https://via.placeholder.com/200x150" alt="Product 3">
      <div class="price">$30</div>
      <button class="buy-btn">Buy</button>
    </div>
  </div>
</body>
</html>
